(ns sustainability.co2
  "This module calculates CO2 emission estimates based on data from multiple sources.

  See `README.md` for more information about the data sources."
  (:require [clojure.test :refer [deftest is]]))


;;;; Helpers

(defn- lerp
  "Linear interpolation"
  [x [x1 y1] [x2 y2]]
  (let [delta (- x2 x1)]
    (cond (<= delta 0) y1
          (<= x x1) y1
          (<= x2 x) y2
          :else (let [f (/ (- x x1) delta)]
                  (double (+ (* (- 1.0 f) y1)
                             (* f y2)))))))

(deftest test-lerp
  (is (= 0.5 (lerp 0.5 [0 0] [1 1])))
  (is (= 0.5 (lerp 50 [0 0] [100 1])))
  (is (= 10.0 (lerp 10 [0 0] [100 100]))))

(defn- sum [f coll]
  (reduce + 0 (map f coll)))

(deftest test-sum
  (is (= 0 (sum identity [])))
  (is (= 10 (sum identity (range 5)))))

(defn- avg [coll]
  (/ (reduce + 0 coll) (count coll)))





;;;; Data

;; Zagheni, E.
(def raw-co2-data-by-age
  [[0 0]
   [1.28290793667969 1.82167385111227]
   [2.11148833972818 1.85593618253938]
   [2.94006874277667 1.89183005355825]
   [3.76864914582516 1.92690815478124]
   [4.59722954887365 1.96198625600423]
   [5.42580995192213 1.99788012702311]
   [6.25439035497062 2.03214245845021]
   [7.08297075801911 2.0672205596732]
   [7.9115511610676 2.14063984130272]
   [8.51415509055741 2.38847070529213]
   [8.89078254648854 2.59306577009971]
   [9.26741000241967 2.81201838331484]
   [9.6440374583508 3.04353385138658]
   [10.0206649142819 3.26428115815266]
   [10.3972923702131 3.46528683585835]
   [10.7739198261442 3.6644978200131]
   [11.1882100276684 3.87088757837163]
   [11.6401629747858 4.07877291468927]
   [12.0921159219032 4.28815382896604]
   [12.5440688690205 4.49005685344721]
   [12.9960218161379 4.68896872201013]
   [13.4856375088483 4.88745328258474]
   [14.0129159471519 5.09640688887319]
   [14.5401943854555 5.30023279930179]
   [15.0674728237591 5.5040587097304]
   [15.5947512620627 5.71301231601885]
   [16.0843669547731 5.91683822644745]
   [16.5363199018905 6.12023682888774]
   [16.9882728490079 6.32213985336891]
   [17.4402257961252 6.51955614397272]
   [17.8921787432426 6.71398127865828]
   [18.3441316903599 6.91139756926209]
   [18.7960846374773 7.11030943782502]
   [19.2103748390015 7.3149045026326]
   [19.5870022949327 7.5159101803383]
   [19.9636297508638 7.71512116449305]
   [20.3402572067949 7.92868969705535]
   [20.7168846627261 8.1404635360667]
   [21.0935121186572 8.35223737507806]
   [21.4701395745883 8.56760060119131]
   [21.8467670305194 8.77937444020266]
   [22.2233944864506 8.98935358566308]
   [22.6000219423817 9.19394865047066]
   [23.2026258718715 9.40099102466589]
   [24.03120627492 9.46543683854069]
   [24.8597866779685 9.48419954384601]
   [25.688367081017 9.54375073894551]
   [26.4416219928792 9.69865635907494]
   [27.1195514135553 9.89407854573325]
   [27.8351435798244 10.0832193049633]
   [28.5883984916867 10.2752515149142]
   [29.2663279123627 10.4585345938044]
   [29.9065945874456 10.6538321489661]
   [30.5845240081217 10.8602219073246]
   [31.2624534287977 11.0566411459557]
   [31.9780455950669 11.2515648066276]
   [32.7313005069291 11.4391102827012]
   [33.4468926731983 11.6369253940941]
   [34.2001475850605 11.8173011600728]
   [35.028727988109 11.9241670033336]
   [35.8573083911575 12.0408220841449]
   [36.685888794206 12.1305567616921]
   [37.5144691972545 12.264343008217]
   [38.343049600303 12.4283127371896]
   [39.1716300033515 12.5816774588157]
   [40.0002104064 12.73341064085]
   [40.8287908094485 12.8484341820696]
   [41.6573712124969 12.9520369461468]
   [42.4859516155454 13.0181142996133]
   [43.3145320185939 13.0735866457334]
   [44.1431124216424 13.1567951649135]
   [44.9716928246909 13.2522402310319]
   [45.8002732277394 13.2734502457249]
   [46.6288536307879 13.2946602604179]
   [47.4574340338364 13.328922591845]
   [48.2860144368848 13.377868779598]
   [49.1145948399333 13.4610772987781]
   [49.9431752429818 13.6022054734659]
   [50.7717556460303 13.7563859648879]
   [51.6003360490788 13.9040402979428]
   [52.4289164521273 14.0190638391624]
   [53.2574968551758 14.1169562146684]
   [54.0860772582243 14.2221905183374]
   [54.9146576612728 14.3217144334352]
   [55.7432380643212 14.4579479893477]
   [56.5718184673697 14.484052622816]
   [57.4003988704182 14.5223938032225]
   [58.2289792734667 14.6113127109738]
   [59.0575596765152 14.6423119632174]
   [59.8861400795637 14.5746030701591]
   [60.7147204826122 14.6235492579121]
   [61.5433008856607 14.6790216040322]
   [62.3718812887091 14.79241360566]
   [63.2004616917576 14.9245683125931]
   [64.0290420948061 14.9188579240219]
   [64.8576224978546 14.9286471615725]
   [65.6862029009031 14.8242286276994]
   [66.5147833039516 14.7744666701505]
   [67.3433637070001 14.7467304970905]
   [68.1719441100486 14.6627062081145]
   [69.0005245130971 14.5599192138332]
   [69.8291049161455 14.3918706358812]
   [70.657685319194 14.2646105477233]
   [71.4862657222425 14.169165481605]
   [72.314846125291 14.0508788612019]
   [73.1434265283395 13.9007772187593]
   [73.972006931388 13.8053321526409]
   [74.8005873344365 13.713965935502]
   [75.629167737485 13.6209681787713]
   [76.4577481405334 13.5279704220405]
   [77.2863285435819 13.4366042049016]
   [78.1149089466304 13.3452379877626]
   [78.9434893496789 13.2522402310319]
   [79.7344070071343 13.1656054787091]])

(def average-co2-by-age (avg (map second raw-co2-data-by-age)))


;; The World Bank
(def raw-co2-data-by-year-finland
  [[1969 8.204342329931]
   [1970 8.76964388174735]
   [1971 8.79913224362571]
   [1972 9.51830728004247]
   [1973 10.5842903284362]
   [1974 9.95206770002989]
   [1975 9.78501774404428]
   [1976 10.8512429152813]
   [1977 10.5972997542469]
   [1978 10.9233904566159]
   [1979 11.4034573078207]
   [1980 12.1866725528739]
   [1981 10.7314031938573]
   [1982 8.92566418469036]
   [1983 8.56224665538254]
   [1984 8.6555809400748]
   [1985 10.131326182539]
   [1986 10.8433328846555]
   [1987 11.6899438639304]
   [1988 10.549939846125]
   [1989 10.5924355774377]
   [1990 10.3771689611267]
   [1991 10.7104772086307]
   [1992 9.41552108769709]
   [1993 9.94837506441891]
   [1994 11.2460279230939]
   [1995 10.3201433496679]
   [1996 11.9586361634423]
   [1997 11.6605782092227]
   [1998 11.0582844894866]
   [1999 10.7295164006246]
   [2000 10.1284741400511]
   [2001 10.996742102171]
   [2002 11.8606758299719]
   [2003 13.2610969393138]
   [2004 12.8326749770283]
   [2005 10.4164380522202]
   [2006 12.5706384483281]
   [2007 12.0984818632864]
   [2008 10.6371591894379]
   [2009 9.95519427234709]
   [2010 11.5752816522205]
   [2011 10.5444747406961]
   [2012 9.07543335566445]
   [2013 8.68178012315563]
   [2014 8.66072124349448]])





;;;; CO2 Calculations

(defn co2-by-year-in-finland
  "Average CO2 emissions for a given `year` in Finland per capita."
  [year]
  (let [data (first (filter (comp #{year} first) raw-co2-data-by-year-finland))
        [year co2] (cond (< year (ffirst raw-co2-data-by-year-finland))
                         (first raw-co2-data-by-year-finland)

                         (> year (first (last raw-co2-data-by-year-finland)))
                         (last raw-co2-data-by-year-finland)

                         :else data)]
    co2))

(defn co2-by-age-in-finland-guess
  "Average CO2 emissions for a person of given `age` in Finland."
  [age]
  (let [[less more] (split-with #(< (first %) age) raw-co2-data-by-age)
        before (or (last less) (first raw-co2-data-by-age))
        after (or (first more) (last raw-co2-data-by-age))
        co2 (lerp age before after)]
    co2))

(defn co2-multiplier-by-age-finland
  "Relative CO2 emissions of a person of given `age` in Finland.

  Multiplier of 1.0 is the average emissions by age."
  [age]
  (/ (co2-by-age-in-finland-guess age) average-co2-by-age))

(defn co2-over-life-in-finland
  "Estimates the CO2 emissions of a person living in Finland from given `birth-year` up until `end-year`."
  [birth-year end-year]
  (sum #(* (co2-multiplier-by-age-finland (inc (- % birth-year)))
           (co2-by-year-in-finland %))
       (range birth-year end-year)))




;; Examples

(comment
  (co2-by-year-in-finland 1979) ; => 11.4034573078207
  (co2-by-year-in-finland 2000) ; => 10.1284741400511

  (co2-multiplier-by-age-finland 1) ; => 0.1433125171218903
  (co2-multiplier-by-age-finland 39) ; => 1.2666295009137765

  (co2-over-life-in-finland 1969 2008) ; => 311.03141542755174
  (co2-over-life-in-finland 1979 2018) ; => 297.5844637544411

  ;; cost to compensate
  (* (co2-over-life-in-finland 1979 2018) 12.87)) ; => 3829.9120485196568â‚¬
